{% extends 'base.html' %} {% block content %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<style>
  .chat {
    display: flex;
    position: fixed;
    bottom: 20px;
    right: 20px;
  }
  .button-background {
    position: absolute;
    top: 10px;
    left: 10px;
    width: 80px;
    height: 80px;
    background-color: #1950ff;
    border-radius: 50%;
    box-shadow: 0 2.1px 1.3px rgba(0, 0, 0, 0.044),
      0 5.9px 4.2px rgba(0, 0, 0, 0.054), 0 12.6px 9.5px rgba(0, 0, 0, 0.061),
      0 25px 20px rgba(0, 0, 0, 0.1);
  }
  .chat-bubble {
    cursor: pointer;
    position: relative;
  }
  .bubble {
    transform-origin: 50%;
    transition: transform 500ms cubic-bezier(0.17, 0.61, 0.54, 0.9);
  }
  .line {
    fill: none;
    stroke: #ffffff;
    stroke-width: 2.75;
    stroke-linecap: round;
    transition: stroke-dashoffset 500ms cubic-bezier(0.4, 0, 0.2, 1);
  }
  .line1 {
    stroke-dasharray: 60 90;
    stroke-dashoffset: -20;
  }
  .line2 {
    stroke-dasharray: 67 87;
    stroke-dashoffset: -18;
  }
  .circle {
    fill: #ffffff;
    stroke: none;
    transform-origin: 50%;
    transition: transform 500ms cubic-bezier(0.4, 0, 0.2, 1);
  }
  .active .bubble {
    transform: translateX(24px) translateY(4px) rotate(45deg);
  }
  .active .line1 {
    stroke-dashoffset: 21;
  }
  .active .line2 {
    stroke-dashoffset: 30;
  }
  .active .circle {
    transform: scale(0);
  }
  #textInput {
    border: 2px solid black;
    border-bottom: 3px solid aqua;
  }

  .userText {
    color: white;
    font-family: monospace;
    font-size: 17px;
    text-align: right;
    line-height: 30px;
  }
  .userText span {
    background-color: #009688;
    padding: 10px;
    border-radius: 10px;
  }
  .botText {
    color: white;
    font-family: monospace;
    font-size: 17px;
    text-align: left;
    line-height: 30px;
  }
  .botText span {
    background-color: #ae312f;
    padding: 5px;
    border-radius: 10px;
  }

  * {
    box-sizing: border-box;
  }

  body {
    background-color: #edeff2;
    font-family: "Calibri", "Roboto", sans-serif;
  }
  .chat_window {
    position: absolute;
    width: calc(100% - 20px);
    max-width: 500px;
    height: 500px;
    border-radius: 10px;
    background-color: #fff;
    left: 80.5%;
    top: 67%;
    transform: translateX(-50%) translateY(-50%);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    background-color: #fff;
    overflow: hidden;
  }

  .top_menu {
    background-color: #fff;
    width: 100%;
    padding: 20px 0 15px;
    box-shadow: 0 1px 30px rgba(0, 0, 0, 0.1);
  }
  .top_menu .buttons {
    margin: 3px 0 0 20px;
    position: absolute;
  }
  .top_menu .buttons .button {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 10px;
    position: relative;
  }
  .top_menu .buttons .button.close {
    background-color: #f5886e;
  }
  .top_menu .buttons .button.minimize {
    background-color: #fdbf68;
  }
  .top_menu .buttons .button.maximize {
    background-color: #a3d063;
  }
  .top_menu .title {
    text-align: center;
    color: #bcbdc0;
    font-size: 20px;
  }

  .messages {
    position: relative;
    list-style: none;
    padding: 20px 10px 0 10px;
    margin: 0;
    height: 347px;
    overflow: scroll;
  }
  .messages .message {
    clear: both;
    overflow: hidden;
    margin-bottom: 20px;
    transition: all 0.5s linear;
    opacity: 0;
  }
  .messages .message.left .avatar {
    background-color: #f5886e;
    float: left;
  }
  .messages .message.left .text_wrapper {
    background-color: #ffe6cb;
    margin-left: 20px;
  }
  .messages .message.left .text_wrapper::after,
  .messages .message.left .text_wrapper::before {
    right: 100%;
    border-right-color: #ffe6cb;
  }
  .messages .message.left .text {
    color: #c48843;
  }
  .messages .message.left .avatar {
    float: left;
    width: 50px;
    height: 50px;
    background-image: url("/static/openai-chatgpt-logo.webp");
    background-size: cover;
    border-radius: 50%;
    margin-right: 10px;
  }

  .messages .message.right .text_wrapper {
    background-color: #c7eafc;
    margin-right: 20px;
    float: right;
  }
  .messages .message.right .text_wrapper::after,
  .messages .message.right .text_wrapper::before {
    left: 100%;
    border-left-color: #c7eafc;
  }
  .messages .message.right .text {
    color: #45829b;
  }
  .messages .message.appeared {
    opacity: 1;
  }
  .messages .message .avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: inline-block;
  }
  .messages .message .text_wrapper {
    display: inline-block;
    padding: 20px;
    border-radius: 6px;
    width: calc(100% - 85px);
    min-width: 100px;
    position: relative;
  }
  .messages .message .text_wrapper::after,
  .messages .message .text_wrapper:before {
    top: 18px;
    border: solid transparent;
    content: " ";
    height: 0;
    width: 0;
    position: absolute;
    pointer-events: none;
  }
  .messages .message .text_wrapper::after {
    border-width: 13px;
    margin-top: 0px;
  }
  .messages .message .text_wrapper::before {
    border-width: 15px;
    margin-top: -2px;
  }
  .messages .message .text_wrapper .text {
    font-size: 18px;
    font-weight: 300;
  }

  .bottom_wrapper {
    position: relative;
    width: 100%;
    background-color: #fff;
    padding: 20px 20px;
    position: absolute;
    bottom: 0;
  }
  .bottom_wrapper .message_input_wrapper {
    display: inline-block;
    height: 50px;
    border-radius: 25px;
    border: 1px solid #bcbdc0;
    width: calc(100% - 160px);
    position: relative;
    padding: 0 20px;
  }
  .bottom_wrapper .message_input_wrapper .message_input {
    border: none;
    height: 100%;
    box-sizing: border-box;
    width: calc(100% - 40px);
    position: absolute;
    outline-width: 0;
    color: gray;
  }
  .bottom_wrapper .send_message {
    width: 140px;
    height: 50px;
    display: inline-block;
    border-radius: 50px;
    background-color: #a3d063;
    border: 2px solid #a3d063;
    color: #fff;
    cursor: pointer;
    transition: all 0.2s linear;
    text-align: center;
    float: right;
  }
  .bottom_wrapper .send_message:hover {
    color: #a3d063;
    background-color: #fff;
  }
  .bottom_wrapper .send_message .text {
    font-size: 18px;
    font-weight: 300;
    display: inline-block;
    line-height: 48px;
  }

  .message_template {
    display: none;
  }
</style>

<div
  class="chat"
  id="openChatbotButton"
  onclick="this.classList.toggle('active')"
>
  <div class="button-background"></div>
  <svg class="chat-bubble" width="100" height="100" viewBox="0 0 100 100">
    <g class="bubble">
      <path
        class="line line1"
        d="M 30.7873,85.113394 30.7873,46.556405 C 30.7873,41.101961
        36.826342,35.342 40.898074,35.342 H 59.113981 C 63.73287,35.342
        69.29995,40.103201 69.29995,46.784744"
      />
      <path
        class="line line2"
        d="M 13.461999,65.039335 H 58.028684 C
          63.483128,65.039335
          69.243089,59.000293 69.243089,54.928561 V 45.605853 C
          69.243089,40.986964 65.02087,35.419884 58.339327,35.419884"
      />
    </g>
    <circle class="circle circle1" r="1.9" cy="50.7" cx="42.5" />
    <circle class="circle circle2" cx="49.9" cy="50.7" r="1.9" />
    <circle class="circle circle3" r="1.9" cy="50.7" cx="57.3" />
  </svg>
</div>

<!-- Initially hide the chatbot window -->
<div class="chat_window" style="display: none">
  <div class="top_menu">
    <div class="title">Real Estate Assistant</div>
  </div>
  <ul class="messages"></ul>
  <div class="bottom_wrapper clearfix">
    <div class="message_input_wrapper">
      <input class="message_input" placeholder="Type your message here..." />
    </div>
    <div class="send_message">
      <div class="icon"></div>
      <div class="text">Send</div>
    </div>
  </div>
  <div class="message_template">
    <li class="message">
      <div class="avatar"></div>
      <div class="text_wrapper">
        <div class="text"></div>
      </div>
    </li>
  </div>
</div>

<script>
  // Define a Message class constructor
  function Message(arg) {
    this.text = arg.text;
    this.message_side = arg.message_side;
  }

  // Define the draw method for Message objects
  Message.prototype.draw = function () {
    var $message = $($(".message_template").clone().html());
    $message.addClass(this.message_side).find(".text").html(this.text);
    $(".messages").append($message);
    // Add animation to show the message
    setTimeout(function () {
      $message.addClass("appeared");
    }, 0);
  };

  // Initialize chat interface when the page is loaded
  $(function () {
    // Initialize message side for user messages
    var message_side = "right";

    // Function to get the message text from input field
    function getMessageText() {
      return $(".message_input").val();
    }

    // Function to send a message
    function sendMessage(text) {
      // If the message is empty, do nothing
      if (text.trim() === "") {
        return;
      }
      // Clear the input field after sending the message
      $(".message_input").val("");

      // Get reference to the messages container
      var $messages = $(".messages");

      // Create a new Message object for the user's message and draw it
      var userMessage = new Message({
        text: text,
        message_side: message_side,
      });
      userMessage.draw();

      // Send an asynchronous request to get the chatbot's response
      $.get("/get", { msg: text }).done(function (data) {
        // Create a new Message object for the chatbot's response and draw it
        var botMessage = new Message({
          text: data,
          message_side: "left",
        });
        botMessage.draw();
        // Scroll to the bottom of the messages container
        $messages.animate({ scrollTop: $messages.prop("scrollHeight") }, 300);
      });

      // Scroll to the bottom of the messages container
      $messages.animate({ scrollTop: $messages.prop("scrollHeight") }, 300);
    }

    // Event listener for clicking the send button
    $(".send_message").click(function (e) {
      sendMessage(getMessageText());
    });

    // Event listener for pressing Enter key in the input field
    $(".message_input").keyup(function (e) {
      if (e.which === 13) {
        sendMessage(getMessageText());
      }
    });

    // Display initial message from the chatbot
    var initialMessage = new Message({
      text: "How can I help you today?",
      message_side: "left",
    });
    initialMessage.draw();
  });

  // Add an event listener for the chatbot button
  $("#openChatbotButton").click(function () {
    // Toggle the visibility of the chatbot window when the button is clicked
    $(".chat_window").toggle();
  });
</script>

<div class="container mt-5">
  <!-- Property Picture -->
  <div class="row mb-4">
    <div class="col-md-12 property-image-container">
      <img
        src="{{ property['images'] }}"
        class="img-fluid"
        alt="Property Image"
      />
    </div>
    <form action="{{ url_for('add_to_favorites') }}" method="post">
      <input type="hidden" name="zpid" value="{{ property['zillow_ID'] }}" />
      <button type="submit" class="btn btn-warning btn-lg">
        Add to Favorites
      </button>
    </form>
  </div>

  <!-- Property Details -->
  <div class="row justify-content-center mb-4">
    <div class="col-md-8">
      <h2 class="mb-3">{{ property['streetAddress'] }}</h2>
      <p><strong>Price:</strong> {{"${:,.0f}".format(property['price']) }}</p>
      <p>
        <strong>Beds:</strong> {{ property['num_beds'] }} |
        <strong>Baths:</strong> {{ property['num_baths'] }} |
        <strong>Sqft:</strong> {{ "{:,.0f}".format(property['sqft']) }}
      </p>
      <p>
        <strong>Zestimate®:</strong> {{ "${:,.0f}".format(property['zestimate'])
        }}
      </p>
      <p><strong>Price per Sqft:</strong> ${{ property['price_per_sqft'] }}</p>
      <p><strong>House Type:</strong> {{ property['house_type'] }}</p>
      <p><strong>Property Tax Rate:</strong> {{ property['property_tax'] }}%</p>
    </div>
  </div>

  <!-- Nearby Schools -->
  <div class="row justify-content-center mb-4">
    <div class="col-md-8">
      <h3>Nearby Schools</h3>
      {% if property['nearby_schools'] %}
      <ul class="list-group">
        {% for school in property['nearby_schools'] %}
        <li class="list-group-item">
          <h5 class="mb-1">{{ school['name'] }}</h5>
          <p class="mb-1">Grade: {{ school['grade'] }}</p>
          <p class="mb-1">Distance: {{ school['distance'] }} miles</p>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p>No nearby school information available.</p>
      {% endif %}
    </div>
  </div>

  <!-- Description -->
  <div class="row justify-content-center">
    <div class="col-md-8">
      <h3>Description</h3>
      <p>{{ property['description'] }}</p>
    </div>
  </div>
</div>
{% endblock %}
